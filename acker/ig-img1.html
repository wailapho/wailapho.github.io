<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liquid Glass Text Editor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.13/html-to-image.min.js"></script>
  <style>
    body { margin: 0; padding: 0; background: #f1f5f9; font-family: system-ui, sans-serif; }
    .preview-wrapper { width: 1080px; height: 1350px; margin: 40px auto; background: #e5e7eb; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.12); }
    #capture-area { width: 1080px; height: 1350px; position: relative; background: white; overflow: hidden; }
    .photo-mask { position: absolute; inset: 0; z-index: 1; }
    .photo-inner { width: 100%; height: 100%; object-fit: cover; object-position: center; }
    .photo-gradient { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0) 30%); pointer-events: none; z-index: 2; }
    .upload-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.25); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 3; pointer-events: none; }
    .text-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 800px; z-index: 7; text-align: left; }
    .glass-box {
      padding: 40px;
      border-radius: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0,0,0,0.3);
      box-shadow: 0 4px 30px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
      background-color: rgba(0,0,0,0.2);
    }
    .glow-top { position: absolute; top: 0; left: 0; right: 0; height: 20px; background: linear-gradient(to bottom, rgba(255,255,255,0.5), transparent); pointer-events: none; }
    .section { margin-bottom: 20px; }
    .label, .description {
      font-family: Verdana, sans-serif;
      color: #ffffff;
    }
    .label { font-size: 36px; font-weight: 700; line-height: 1.1; display: block; }
    .description { font-size: 32px; font-weight: 400; line-height: 1.2; margin-top: 8px; white-space: pre-wrap; word-wrap: break-word; }
    .control-panel { max-width: 1140px; margin: 0 auto 32px; padding: 20px; background: white; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); }
    .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
  </style>
</head>
<body>
  <!-- Control panel + preview area same as before -->
  <div class="control-panel">
    <h1 class="text-2xl font-bold mb-4">Liquid Glass Text Editor</h1>
    <div class="flex flex-wrap gap-4 mb-6 justify-center md:justify-start">
      <button id="upload-bg" class="btn btn-primary">Upload Background Image</button>
      <button id="download" class="btn bg-green-600 hover:bg-green-700 text-white">Download JPG</button>
    </div>
    <input type="file" id="file-bg" accept="image/*" class="hidden">
  </div>

  <div class="preview-wrapper">
    <div id="capture-area">
      <div class="photo-mask" id="mask-bg">
        <img class="photo-inner" id="inner-bg" crossorigin="anonymous">
        <div class="photo-gradient"></div>
        <div class="upload-overlay">
          <svg class="w-16 h-16 mb-3" fill="none" stroke="white" viewBox="0 0 24 24">...</svg>
          <p class="text-lg font-semibold">Background Image<br>Drag & wheel to adjust</p>
        </div>
      </div>
      <div class="text-container">
        <div class="glass-box" id="glass-box">
          <div class="glow-top"></div>
          <div class="section"><span class="label">Nose:</span><div contenteditable="true" class="description">Enter description here...</div></div>
          <div class="section"><span class="label">Palate:</span><div contenteditable="true" class="description">Enter description here...</div></div>
          <div class="section"><span class="label">Overall:</span><div contenteditable="true" class="description">Enter description here...</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast same as before -->

  <script>
    // ... (all previous upload, drag, zoom, clear placeholder code remains the same)

    document.getElementById('download').onclick = async () => {
      try {
        showToast('Creating...');

        const pixelRatio = 2;
        const options = {
          quality: 0.92,
          pixelRatio,
          canvasWidth: 1080 * pixelRatio,
          canvasHeight: 1350 * pixelRatio,
          backgroundColor: '#ffffff',
          cacheBust: true
        };

        const textContainer = document.querySelector('.text-container');
        const glassBox = document.getElementById('glass-box');

        // 1. Capture background only
        textContainer.style.display = 'none';
        const bgDataUrl = await htmlToImage.toPng(captureArea, options);
        textContainer.style.display = '';

        const bgImg = new Image();
        bgImg.src = bgDataUrl;
        await new Promise(r => bgImg.onload = r);

        // 2. Get glass box position/size
        const captureRect = captureArea.getBoundingClientRect();
        const rect = glassBox.getBoundingClientRect();
        const x = rect.left - captureRect.left;
        const y = rect.top - captureRect.top;
        const w = rect.width;
        const h = rect.height;

        // 3. Create blurred + tinted + grained background
        const blurCanvas = document.createElement('canvas');
        blurCanvas.width = w * pixelRatio;
        blurCanvas.height = h * pixelRatio;
        const bctx = blurCanvas.getContext('2d');

        // Blur the background section
        bctx.filter = `blur(${20}px)`;   // 10px Ã— pixelRatio
        bctx.drawImage(bgImg, x * pixelRatio, y * pixelRatio, w * pixelRatio, h * pixelRatio, 0, 0, w * pixelRatio, h * pixelRatio);
        bctx.filter = 'none';

        // Tint
        bctx.fillStyle = 'rgba(0,0,0,0.2)';
        bctx.fillRect(0, 0, blurCanvas.width, blurCanvas.height);

        // Grain (canvas-generated, reliable)
        const noiseSize = 64;
        const noiseCanvas = document.createElement('canvas');
        noiseCanvas.width = noiseSize; noiseCanvas.height = noiseSize;
        const nctx = noiseCanvas.getContext('2d');
        const id = nctx.createImageData(noiseSize, noiseSize);
        for (let i = 0; i < id.data.length; i += 4) {
          const v = 128 + (Math.random() - 0.5) * 120;
          id.data[i] = id.data[i+1] = id.data[i+2] = v;
          id.data[i+3] = 255;
        }
        nctx.putImageData(id, 0, 0);
        const pattern = bctx.createPattern(noiseCanvas, 'repeat');
        bctx.globalAlpha = 0.08;
        bctx.fillStyle = pattern;
        bctx.fillRect(0, 0, blurCanvas.width, blurCanvas.height);
        bctx.globalAlpha = 1;

        // 4. Temporarily apply baked background to glass box
        const originalStyle = {
          backdropFilter: glassBox.style.backdropFilter,
          backgroundImage: glassBox.style.backgroundImage,
          backgroundColor: glassBox.style.backgroundColor,
          backgroundSize: glassBox.style.backgroundSize
        };

        glassBox.style.backdropFilter = 'none';
        glassBox.style.backgroundImage = `url(${blurCanvas.toDataURL('image/png')})`;
        glassBox.style.backgroundColor = 'transparent';
        glassBox.style.backgroundSize = '100% 100%';

        // 5. Capture final image
        const dataUrl = await htmlToImage.toJpeg(captureArea, options);

        // 6. Restore
        glassBox.style.backdropFilter = originalStyle.backdropFilter;
        glassBox.style.backgroundImage = originalStyle.backgroundImage;
        glassBox.style.backgroundColor = originalStyle.backgroundColor;
        glassBox.style.backgroundSize = originalStyle.backgroundSize;

        const a = document.createElement('a');
        a.href = dataUrl;
        a.download = `glass-photo-${Date.now()}.jpg`;
        a.click();
        showToast('Downloaded!');
      } catch (err) {
        console.error(err);
        showToast('Export failed');
      }
    };

    // showToast function (same as before)
  </script>
</body>
</html>
